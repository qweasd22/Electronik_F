{% extends 'base_generic.html' %}
{% load static %}
{% load widget_tweaks %}
{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-5">
            {% if product.image %}
            <img src="{{ product.image.url }}" class="img-fluid" alt="{{ product.name }}">
            {% else %}
            <img src="{% static 'media/no_image.jpeg' %}" class="img-fluid" alt="Нет изображения">
            {% endif %}
        </div>
        <div class="col-md-7">
    <h2 class="fw-bold">{{ product.name }}</h2>
<p class="fw-bold h4">{{ product.price }} ₽</p>
<p class="mb-2">Средняя оценка: {{ average_rating }} ⭐</p>
<p>{{ product.description }}</p>

    {% if user.is_authenticated %}
        <div class="mb-3">
            {% if quantity_in_cart > 0 %}
            <!-- Карточка количества товара в корзине -->
            <div class="card p-2 mb-3 border">
                <div class="d-flex align-items-center justify-content-between">
                    <span>В корзине: <strong>{{ quantity_in_cart }}</strong> шт.</span>
                    <div class="btn-group" role="group" aria-label="Cart controls">
                        <a href="{% url 'orders:decrease_cart' product.id %}" class="btn btn-outline-secondary">-</a>
                        <a href="{% url 'orders:add_to_cart' product.id %}" class="btn btn-outline-secondary">+</a>
                        <a href="{% url 'orders:remove_from_cart' product.id %}" class="btn btn-danger">Удалить</a>
                    </div>
                    <div><a href="{% url 'orders:cart'  %}" class="btn btn-outline-secondary">Перейти в корзину</a></div>
                </div>
            </div>
            {% else %}
            <form action="{% url 'orders:add_to_cart' product.id %}" method="post">
                {% csrf_token %}
                <button type="submit" class="btn btn-success btn-lg w-100 mb-3">Добавить в корзину</button>
            </form>
            {% endif %}
        </div>
    {% else %}
        <a href="{% url 'accounts:login' %}" class="btn btn-success btn-lg w-100 mb-3">Войдите, чтобы купить</a>
    {% endif %}
</div>


            <hr>
            <h4>Отзывы</h4>
            {% for review in reviews %}
            <div class="list-group-item border-0 mb-3">
                <p><strong>{{ review.user.username }}</strong> ({{ review.created_at|date:"d.m.Y H:i" }})</p>
                <p>{{ review.text }}</p>
                {% for r in review.user.ratings.all %}
                    {% if r.product == product %}
                    <p>Оценка: {{ r.stars }} ⭐</p>
                    {% endif %}
                {% endfor %}
            </div>
            {% empty %}
            <p>Отзывов пока нет.</p>
            {% endfor %}

            {% if user.is_authenticated %}
            <hr>
            <h5 class="fw-bold mb-3">Оставить отзыв</h5>
            <form method="post">
                {% csrf_token %}
                <div class="form-floating mb-3">
    {{ review_form.text|add_class:"form-control" }}
    <label for="{{ review_form.text.id_for_label }}">Ваш отзыв</label>
</div>
<div class="form-floating mb-3">
    {{ rating_form.stars|add_class:"form-control" }}
    <label for="{{ rating_form.stars.id_for_label }}">Ваша оценка</label>
</div>

                <button type="submit" class="btn btn-primary btn-lg w-100">Оставить отзыв</button>
            </form>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
